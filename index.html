<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* Hide Number Input Arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#F0EFEA] text-slate-900 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-[#2C2E33] text-gray-100 flex-shrink-0 hidden md:flex flex-col h-screen shadow-2xl z-20">
        <div class="p-6 border-b border-gray-700 flex-shrink-0">
            <h1 class="text-xl font-bold flex items-center gap-2 text-white tracking-tight">
                <div class="bg-emerald-500 p-1.5 rounded-lg shadow-lg shadow-emerald-500/20">
                    <i data-lucide="file-spreadsheet" class="text-white w-5 h-5"></i>
                </div>
                Project Tracker
            </h1>
            <p class="text-xs text-gray-400 mt-2 flex items-center gap-2 pl-1">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                </span>
                Live Sync Active
            </p>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 font-medium text-sm text-gray-400 hover:bg-white/5 hover:text-white">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Dashboard
            </button>
            
            <button onclick="switchTab('list'); filterByType(null)" id="nav-list" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 font-medium text-sm text-gray-400 hover:bg-white/5 hover:text-white">
                <i data-lucide="table" class="w-4 h-4"></i> All Projects
            </button>

            <button onclick="switchTab('add')" id="nav-add" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 font-medium text-sm text-gray-400 hover:bg-white/5 hover:text-white">
                <i data-lucide="plus-circle" class="w-4 h-4"></i> Add New Data
            </button>

            <!-- Filters -->
            <div class="pt-8 pb-3 px-4">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="filter" class="w-3 h-3"></i> Filter by Type
                </p>
            </div>
            <div id="type-filters" class="space-y-1">
                <!-- Filter buttons injected via JS -->
            </div>
        </nav>

        <div class="p-4 border-t border-gray-700/50 bg-[#25272b] flex-shrink-0">
            <button onclick="fetchData()" class="w-full flex items-center justify-center gap-2 bg-gray-800 hover:bg-gray-700 text-gray-300 py-2.5 rounded-xl text-xs font-medium transition-all hover:shadow-lg border border-gray-700">
                <i data-lucide="refresh-cw" id="sync-icon" class="w-3 h-3"></i> Sync Database
            </button>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full bg-[#2C2E33] text-white z-50 p-4 flex justify-between items-center shadow-md">
        <h1 class="font-bold flex gap-2 items-center">
            <i data-lucide="file-spreadsheet" class="text-emerald-400 w-5 h-5"></i> Project Tracker
        </h1>
        <div class="flex gap-4">
            <button onclick="switchTab('list')"><i data-lucide="table" class="w-6 h-6"></i></button>
            <button onclick="switchTab('dashboard')"><i data-lucide="layout-dashboard" class="w-6 h-6"></i></button>
            <button onclick="switchTab('add')"><i data-lucide="plus-circle" class="w-6 h-6"></i></button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 p-4 md:p-8 mt-14 md:mt-0 overflow-y-auto h-screen scroll-smooth custom-scrollbar relative">
        
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden fixed top-6 right-6 bg-white/80 backdrop-blur-md text-emerald-700 px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 z-50 border border-white/40 fade-in">
            <i data-lucide="loader-2" class="animate-spin w-5 h-5 text-emerald-500"></i>
            <span class="text-sm font-medium">Syncing Data...</span>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="view-section fade-in hidden max-w-[1920px] mx-auto pb-10">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 border-b border-slate-200 pb-6 mb-8">
                <div>
                    <h2 class="text-4xl font-extrabold text-slate-800 tracking-tight">Overview</h2>
                    <p class="text-slate-500 mt-2 font-medium">Real-time project insights and performance metrics.</p>
                </div>
                <div class="bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200 text-sm font-semibold text-slate-600 flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    Total Database: <span id="dash-total-count">0</span> Projects
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Card 1 -->
                <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-sm border border-white/20 hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <i data-lucide="box" class="absolute top-0 right-0 p-4 w-32 h-32 text-blue-500 opacity-5"></i>
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Total Projects</p>
                            <h3 id="stat-total" class="text-3xl font-extrabold text-slate-800 mt-2">0</h3>
                        </div>
                        <div class="p-3 rounded-xl bg-blue-500 text-white shadow-lg bg-gradient-to-br from-white/20 to-transparent">
                            <i data-lucide="box" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 z-10 relative"><span class="text-xs font-medium text-slate-500 bg-slate-50 px-2 py-1 rounded-md border border-slate-100">All Time</span></div>
                </div>
                <!-- Card 2 -->
                <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-sm border border-white/20 hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <i data-lucide="file-spreadsheet" class="absolute top-0 right-0 p-4 w-32 h-32 text-violet-500 opacity-5"></i>
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Total Budget (PBOQ)</p>
                            <h3 id="stat-budget" class="text-3xl font-extrabold text-slate-800 mt-2">฿0</h3>
                        </div>
                        <div class="p-3 rounded-xl bg-violet-500 text-white shadow-lg bg-gradient-to-br from-white/20 to-transparent">
                            <i data-lucide="file-spreadsheet" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 z-10 relative"><span class="text-xs font-medium text-slate-500 bg-slate-50 px-2 py-1 rounded-md border border-slate-100">Planned Investment</span></div>
                </div>
                <!-- Card 3 -->
                <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-sm border border-white/20 hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <i data-lucide="check-circle" class="absolute top-0 right-0 p-4 w-32 h-32 text-emerald-500 opacity-5"></i>
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Completed</p>
                            <h3 id="stat-completed" class="text-3xl font-extrabold text-slate-800 mt-2">0</h3>
                        </div>
                        <div class="p-3 rounded-xl bg-emerald-500 text-white shadow-lg bg-gradient-to-br from-white/20 to-transparent">
                            <i data-lucide="check-circle" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 z-10 relative"><span class="text-xs font-medium text-slate-500 bg-slate-50 px-2 py-1 rounded-md border border-slate-100">Successfully delivered</span></div>
                </div>
                <!-- Card 4 -->
                <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-sm border border-white/20 hover:-translate-y-1 transition-all duration-300 group relative overflow-hidden">
                    <i data-lucide="activity" class="absolute top-0 right-0 p-4 w-32 h-32 text-amber-500 opacity-5"></i>
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider">Active / WIP</p>
                            <h3 id="stat-active" class="text-3xl font-extrabold text-slate-800 mt-2">0</h3>
                        </div>
                        <div class="p-3 rounded-xl bg-amber-500 text-white shadow-lg bg-gradient-to-br from-white/20 to-transparent">
                            <i data-lucide="activity" class="w-6 h-6"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center gap-2 z-10 relative"><span class="text-xs font-medium text-slate-500 bg-slate-50 px-2 py-1 rounded-md border border-slate-100">Needs attention</span></div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Status Chart -->
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-6">
                        <span class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="pie-chart" class="w-5 h-5"></i></span>
                        Status Distribution
                    </h3>
                    <div class="h-80 relative">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <!-- Region Chart -->
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2 mb-6">
                        <span class="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><i data-lucide="bar-chart-2" class="w-5 h-5"></i></span>
                        Sub Region Load
                    </h3>
                    <div class="h-80">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- LIST VIEW -->
        <div id="view-list" class="view-section fade-in hidden h-full flex flex-col max-w-[1920px] mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                <div>
                    <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2" id="list-title">
                        <i data-lucide="table" class="text-emerald-600 w-6 h-6"></i> Master Data
                    </h2>
                    <p class="text-xs text-slate-500 mt-1" id="list-subtitle">Manage all records.</p>
                </div>
                <div class="relative w-full md:w-72">
                    <i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="search-input" placeholder="Search CCT, Name..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col relative">
                <div class="overflow-auto flex-1 relative z-10 custom-scrollbar">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200 sticky top-0 z-20 shadow-sm">
                            <tr>
                                <th class="px-3 py-4 w-28 pl-6">CCT No</th>
                                <th class="px-3 py-4 w-24">Year</th>
                                <th class="px-3 py-4 w-32">Type</th>
                                <th class="px-3 py-4 min-w-[200px]">Project Name</th>
                                <th class="px-3 py-4 w-28">Region</th>
                                <th class="px-3 py-4 w-36">Status</th>
                                <th class="px-3 py-4 w-28 text-right">PBOQ</th>
                                <th class="px-3 py-4 w-28 text-right">FBOQ</th>
                                <th class="px-3 py-4 w-32 text-center">Drive</th>
                                <th class="px-3 py-4 w-24 text-center sticky right-0 bg-slate-50 shadow-l z-20">Action</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100 bg-white">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ADD FORM VIEW -->
        <div id="view-add" class="view-section fade-in hidden max-w-4xl mx-auto pb-10">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-emerald-100 p-2.5 rounded-xl text-emerald-600">
                    <i data-lucide="plus-circle" class="w-8 h-8"></i>
                </div>
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">Add New Project</h2>
                    <p class="text-slate-500">Create a new record. CCT No. is auto-generated.</p>
                </div>
            </div>

            <div class="bg-white p-8 md:p-10 rounded-3xl shadow-sm border border-slate-100">
                <form id="add-form" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Project Info -->
                    <div class="col-span-full border-b border-slate-100 pb-4 mb-2">
                        <h3 class="text-slate-800 font-bold flex items-center gap-2 text-lg">
                            <span class="w-1 h-6 bg-emerald-500 rounded-full"></span> Project Information
                        </h3>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">CCT NO (Auto)</label>
                        <input id="input-cct" readonly class="w-full px-4 py-3 border border-slate-200 rounded-xl bg-slate-50 font-mono text-slate-500 cursor-not-allowed outline-none" placeholder="Loading...">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Year</label>
                        <select id="input-year" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none">
                            <option value="2023">2023</option>
                            <option value="2024" selected>2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Project Type</label>
                        <select id="input-type" required class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none">
                            <option value="">Select Type</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Project Name</label>
                        <input id="input-name" required class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none" placeholder="Enter project name">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Sub Region</label>
                        <input id="input-region" list="regions-list" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none" placeholder="Select or type...">
                        <datalist id="regions-list">
                            <option value="NOE1"><option value="NOE2"><option value="EAST"><option value="NOE">
                        </datalist>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Initial Status</label>
                        <select id="input-status" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none">
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <!-- Financial Info -->
                    <div class="col-span-full border-b border-slate-100 pb-4 mb-2 mt-4">
                        <h3 class="text-slate-800 font-bold flex items-center gap-2 text-lg">
                            <span class="w-1 h-6 bg-violet-500 rounded-full"></span> Financial & Reference
                        </h3>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">Work Order</label>
                        <input id="input-wo" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">PO No.</label>
                        <input id="input-po" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all outline-none">
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">PBOQ (Budget)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 text-slate-400">฿</span>
                            <input type="number" id="input-pboq" class="w-full pl-8 pr-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all font-mono outline-none">
                        </div>
                    </div>

                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-700">FBOQ (Final)</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3.5 text-slate-400">฿</span>
                            <input type="number" id="input-fboq" class="w-full pl-8 pr-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all font-mono outline-none">
                        </div>
                    </div>

                    <div class="col-span-full">
                        <label class="text-sm font-semibold text-slate-700 mb-2 block">Link Google Drive</label>
                        <div class="flex bg-slate-50 rounded-xl p-4 border border-slate-200">
                            <div class="flex items-center gap-4 w-full">
                                <div class="bg-white p-3 rounded-full shadow-sm border border-slate-100">
                                    <i data-lucide="folder-open" class="text-emerald-500 w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-bold text-slate-700">Auto Generated Folder</p>
                                    <p class="text-xs text-slate-500 mt-0.5">Folder will be created based on CCT No.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-full mt-6 flex justify-end gap-4 pt-4 border-t border-slate-100">
                        <button type="button" onclick="switchTab('list')" class="px-8 py-3 rounded-xl text-slate-600 hover:bg-slate-50 font-medium transition-colors">Cancel</button>
                        <button type="submit" class="px-8 py-3 rounded-xl bg-gradient-to-r from-emerald-600 to-emerald-500 text-white hover:shadow-lg hover:shadow-emerald-500/30 font-bold transition-all transform hover:-translate-y-0.5">
                            Save Project
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <!-- LOGIC SCRIPT -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const API_URL = "https://script.google.com/macros/s/AKfycbw8_0YdKMTdoC52wLmLQ5w8ZQe_hjm7JeXPE_r-1Fkt7KkO6ZtG502HgzvhEUV_dPLm/exec";
        
        const PROJECT_TYPES = ["RAUG", "IMPROVE", "Closeloop", "MOBILE", "Online", "Event", "Battery", "CM Site"];
        
        const STATUS_OPTIONS = [
            "Assign", "Wait Survey", "Surveyed", "Wait GATE", "GATE REJECT", "PASS GATE",
            "Lay OFC", "Wait CUT OFC", "Wait PAT", "Cancel", "Completed", "RE GATE"
        ];

        const STATUS_COLORS = {
            'Assign': '#64748b', 'Wait Survey': '#f59e0b', 'Surveyed': '#3b82f6',
            'Wait GATE': '#d97706', 'GATE REJECT': '#ef4444', 'PASS GATE': '#10b981',
            'Lay OFC': '#6366f1', 'Wait CUT OFC': '#8b5cf6', 'Wait PAT': '#a855f7',
            'Cancel': '#9ca3af', 'Completed': '#059669', 'RE GATE': '#f43f5e'
        };

        const INITIAL_DATA = [
            { id: 1, cctNo: 'CCT0001', year: '2024', subRegion: 'NOE1', googleDrive: 'https://drive.google.com', project: 'RAUG', projectName: 'Example Project', lastStatus: 'Completed', workOrder: 'WO-998', poNo: 'PO-5501', pboq: '150000', fboq: '145000' }
        ];

        // --- STATE ---
        let globalData = [...INITIAL_DATA];
        let currentFilterType = null;
        let searchTerm = "";
        let dirtyRows = new Set();
        let charts = {};

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initFilters();
            initFormDropdowns();
            renderList();
            updateStats();
            
            // Search Listener
            document.getElementById('search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                renderList();
            });

            // Form Submit
            document.getElementById('add-form').addEventListener('submit', handleFormSubmit);

            // Initial Fetch
            fetchData();
        });

        // --- NAVIGATION ---
        function switchTab(tabId) {
            // Update UI visibility
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            // Update Sidebar Active State
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('bg-gradient-to-r', 'from-emerald-600', 'to-emerald-500', 'text-white', 'shadow-lg');
                el.classList.add('text-gray-400');
            });
            
            // Highlight active button (approximate logic for filters)
            const activeBtn = document.getElementById(`nav-${tabId}`);
            if(activeBtn) {
                activeBtn.classList.remove('text-gray-400');
                activeBtn.classList.add('bg-gradient-to-r', 'from-emerald-600', 'to-emerald-500', 'text-white', 'shadow-lg');
            }

            // Logic per tab
            if(tabId === 'dashboard') {
                updateStats();
                setTimeout(() => renderCharts(), 100); // Wait for visibility
            } else if (tabId === 'add') {
                generateNextCCT();
            } else if (tabId === 'list') {
                renderList();
            }
        }

        function filterByType(type) {
            currentFilterType = type;
            switchTab('list');
            
            // Update Sidebar Styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('bg-white/10', 'text-white', 'border-l-2', 'border-emerald-400');
                btn.classList.add('text-gray-400');
                btn.querySelector('.dot').classList.remove('bg-emerald-400', 'shadow-[0_0_8px_rgba(52,211,153,0.6)]');
                btn.querySelector('.dot').classList.add('bg-gray-600');
            });

            if (type) {
                const activeBtn = document.getElementById(`filter-${type}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-gray-400');
                    activeBtn.classList.add('bg-white/10', 'text-white', 'border-l-2', 'border-emerald-400');
                    activeBtn.querySelector('.dot').classList.remove('bg-gray-600');
                    activeBtn.querySelector('.dot').classList.add('bg-emerald-400', 'shadow-[0_0_8px_rgba(52,211,153,0.6)]');
                }
            }
            renderList();
        }

        // --- DATA OPERATIONS ---
        async function fetchData() {
            setLoading(true);
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                if (Array.isArray(json)) {
                    // Add temp ID if missing
                    globalData = json.map((item, idx) => ({ ...item, id: item.id || Date.now() + idx }));
                    renderList();
                    updateStats();
                }
            } catch (e) {
                console.error("Fetch error", e);
                // alert("Could not sync data. Using local cache.");
            } finally {
                setLoading(false);
            }
        }

        async function saveRow(id) {
            const item = globalData.find(d => d.id === id);
            if(!item) return;

            // Optimistic UI
            dirtyRows.delete(id);
            renderList(); // Re-render to remove orange highlight

            try {
                const payload = { ...item, action: 'update' };
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                alert("Save failed. Please try again.");
                dirtyRows.add(id);
                renderList();
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const newItem = {
                id: Date.now(),
                cctNo: document.getElementById('input-cct').value,
                year: document.getElementById('input-year').value,
                project: document.getElementById('input-type').value,
                projectName: document.getElementById('input-name').value,
                subRegion: document.getElementById('input-region').value,
                lastStatus: document.getElementById('input-status').value,
                workOrder: document.getElementById('input-wo').value,
                poNo: document.getElementById('input-po').value,
                pboq: document.getElementById('input-pboq').value || 0,
                fboq: document.getElementById('input-fboq').value || 0,
                googleDrive: 'Generating...',
                action: 'create'
            };

            // Optimistic Update
            globalData.unshift(newItem);
            switchTab('list');
            filterByType(null);

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(newItem)
                });
                const result = await res.json();
                
                if (result.status === 'success' && result.driveLink) {
                    // Update the row with real link
                    const target = globalData.find(d => d.id === newItem.id);
                    if(target) target.googleDrive = result.driveLink;
                    renderList();
                }
            } catch (e) {
                console.error(e);
                alert("Error saving data to server.");
            }
            
            // Reset Form
            e.target.reset();
        }

        function deleteRow(id) {
            if(confirm("Delete this row locally?")) {
                globalData = globalData.filter(d => d.id !== id);
                renderList();
                updateStats();
            }
        }

        // --- RENDERING ---
        function renderList() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const filtered = globalData.filter(item => {
                const matchesSearch = (item.projectName || '').toLowerCase().includes(searchTerm) || 
                                      (item.cctNo || '').toLowerCase().includes(searchTerm);
                const matchesType = currentFilterType ? item.project === currentFilterType : true;
                return matchesSearch && matchesType;
            });

            // Update Title
            const listTitle = document.getElementById('list-title');
            listTitle.innerHTML = currentFilterType 
                ? `<span class="bg-emerald-100 text-emerald-700 p-1.5 rounded mr-2"><i data-lucide="box" class="w-5 h-5 inline"></i></span> ${currentFilterType} Projects`
                : `<span class="bg-slate-200 text-slate-700 p-1.5 rounded mr-2"><i data-lucide="table" class="w-5 h-5 inline"></i></span> Master Data`;

            filtered.forEach(item => {
                const isDirty = dirtyRows.has(item.id);
                const tr = document.createElement('tr');
                tr.className = `transition-colors duration-200 group ${isDirty ? 'bg-orange-50' : 'hover:bg-slate-50'}`;
                
                tr.innerHTML = `
                    <td class="px-3 py-2 pl-6">
                        <div class="px-2.5 py-1 bg-slate-100 rounded text-slate-600 font-mono text-xs font-medium border border-slate-200 inline-block">${item.cctNo}</div>
                    </td>
                    <td class="px-3 py-2">
                        <select onchange="updateItem(${item.id}, 'year', this.value)" class="w-full bg-transparent border-0 border-b border-transparent hover:border-slate-300 focus:border-emerald-500 text-sm py-1 cursor-pointer text-slate-600">
                            <option value="2023" ${item.year == '2023'?'selected':''}>2023</option>
                            <option value="2024" ${item.year == '2024'?'selected':''}>2024</option>
                            <option value="2025" ${item.year == '2025'?'selected':''}>2025</option>
                        </select>
                    </td>
                    <td class="px-3 py-2">
                        <select onchange="updateItem(${item.id}, 'project', this.value)" class="w-full bg-transparent text-sm py-1 cursor-pointer text-slate-700 font-medium border-0 border-b border-transparent hover:border-slate-300 focus:border-emerald-500">
                            <option value="">-</option>
                            ${PROJECT_TYPES.map(t => `<option value="${t}" ${item.project === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-3 py-2">
                        <input onchange="updateItem(${item.id}, 'projectName', this.value)" value="${item.projectName || ''}" class="w-full bg-transparent text-sm py-1 font-medium text-slate-800 border-0 border-b border-transparent hover:border-slate-300 focus:border-emerald-500 focus:ring-0">
                    </td>
                    <td class="px-3 py-2">
                        <input list="regions-${item.id}" onchange="updateItem(${item.id}, 'subRegion', this.value)" value="${item.subRegion || ''}" class="w-full bg-transparent text-sm py-1 text-slate-600 border-0 border-b border-transparent hover:border-slate-300 focus:border-emerald-500">
                        <datalist id="regions-${item.id}"><option value="NOE1"><option value="NOE2"><option value="EAST"><option value="NOE"></datalist>
                    </td>
                    <td class="px-3 py-2">
                        <select onchange="updateItem(${item.id}, 'lastStatus', this.value)" style="color: ${STATUS_COLORS[item.lastStatus] || '#334155'}" class="w-full text-xs font-bold rounded-lg px-2 py-1.5 border bg-white shadow-sm cursor-pointer border-slate-200">
                            ${STATUS_OPTIONS.map(s => `<option value="${s}" ${item.lastStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-3 py-2 text-right">
                        <input type="number" onchange="updateItem(${item.id}, 'pboq', this.value)" value="${item.pboq}" class="w-full bg-transparent text-sm py-1 text-right font-mono text-slate-600 border-0 border-b border-transparent hover:border-slate-300 focus:border-emerald-500">
                    </td>
                    <td class="px-3 py-2 text-right">
                        <input type="number" onchange="updateItem(${item.id}, 'fboq', this.value)" value="${item.fboq}" class="w-full bg-transparent text-sm py-1 text-right font-mono text-slate-600 border-0 border-b border-transparent hover:border-slate-300 focus:border-emerald-500">
                    </td>
                    <td class="px-3 py-2 text-center">
                        ${renderDriveLink(item.googleDrive)}
                    </td>
                    <td class="px-3 py-2 text-center sticky right-0 z-20 ${isDirty ? 'bg-orange-50' : 'bg-white group-hover:bg-slate-50'}">
                        ${isDirty 
                            ? `<button onclick="saveRow(${item.id})" class="text-white bg-emerald-500 p-2 rounded-lg shadow-md hover:bg-emerald-600"><i data-lucide="save" class="w-3.5 h-3.5"></i></button>`
                            : `<button onclick="deleteRow(${item.id})" class="text-slate-300 hover:text-rose-500 p-2"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>`
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        function renderDriveLink(link) {
            if (link === 'Generating...') return `<span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-orange-50 text-orange-600 text-[10px] font-bold border border-orange-100"><i data-lucide="loader-2" class="animate-spin w-3 h-3"></i> Creating</span>`;
            if (link && link.startsWith('http')) return `<a href="${link}" target="_blank" class="inline-flex items-center justify-center gap-1.5 text-emerald-600 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200/60 px-3 py-1.5 rounded-lg transition-all text-xs font-semibold"><i data-lucide="folder-open" class="w-3.5 h-3.5"></i> Open</a>`;
            return `<span class="text-slate-300 text-xs">-</span>`;
        }

        function updateItem(id, field, value) {
            const item = globalData.find(d => d.id === id);
            if(item) {
                item[field] = value;
                dirtyRows.add(id);
                renderList();
            }
        }

        // --- DASHBOARD LOGIC ---
        function updateStats() {
            const total = globalData.length;
            const completed = globalData.filter(d => d.lastStatus === 'Completed').length;
            const pboq = globalData.reduce((sum, d) => sum + (parseFloat(d.pboq)||0), 0);
            
            document.getElementById('dash-total-count').innerText = total;
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-budget').innerText = `฿${(pboq/1000000).toFixed(2)}M`;
            document.getElementById('stat-completed').innerText = completed;
            document.getElementById('stat-active').innerText = total - completed;
        }

        function renderCharts() {
            // Prepare Data
            const statusCounts = {};
            const regionCounts = {};
            
            globalData.forEach(d => {
                statusCounts[d.lastStatus] = (statusCounts[d.lastStatus] || 0) + 1;
                regionCounts[d.subRegion] = (regionCounts[d.subRegion] || 0) + 1;
            });

            // Status Chart (Doughnut)
            if (charts.status) charts.status.destroy();
            charts.status = new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: Object.keys(statusCounts).map(k => STATUS_COLORS[k] || '#cbd5e1'),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } }
                    }
                }
            });

            // Region Chart (Bar)
            if (charts.region) charts.region.destroy();
            charts.region = new Chart(document.getElementById('regionChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(regionCounts),
                    datasets: [{
                        label: 'Projects',
                        data: Object.values(regionCounts),
                        backgroundColor: '#6366f1',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { display: false } },
                        x: { grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- HELPERS ---
        function initFilters() {
            const container = document.getElementById('type-filters');
            container.innerHTML = PROJECT_TYPES.map(type => `
                <button id="filter-${type}" onclick="filterByType('${type}')" class="filter-btn w-full flex items-center justify-between px-4 py-2.5 rounded-lg transition-all text-xs font-medium text-gray-400 hover:bg-white/5 hover:text-white group">
                    <div class="flex items-center gap-3">
                        <div class="dot w-1.5 h-1.5 rounded-full bg-gray-600 group-hover:bg-gray-400 transition-colors"></div>
                        ${type}
                    </div>
                </button>
            `).join('');
        }

        function initFormDropdowns() {
            // Project Types
            const typeSelect = document.getElementById('input-type');
            PROJECT_TYPES.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.innerText = t;
                typeSelect.appendChild(opt);
            });

            // Statuses
            const statusSelect = document.getElementById('input-status');
            STATUS_OPTIONS.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.innerText = s;
                statusSelect.appendChild(opt);
            });
        }

        function generateNextCCT() {
            if(!globalData.length) {
                document.getElementById('input-cct').value = 'CCT0001';
                return;
            }
            const maxNum = globalData.reduce((max, item) => {
                if (!item.cctNo) return max;
                const match = item.cctNo.toString().match(/(\d+)$/); 
                return match ? Math.max(max, parseInt(match[1], 10)) : max;
            }, 0);
            document.getElementById('input-cct').value = `CCT${String(maxNum + 1).padStart(4, '0')}`;
        }

        function setLoading(state) {
            const el = document.getElementById('loading-indicator');
            const icon = document.getElementById('sync-icon');
            if(state) {
                el.classList.remove('hidden');
                icon.classList.add('animate-spin', 'text-emerald-400');
            } else {
                el.classList.add('hidden');
                icon.classList.remove('animate-spin', 'text-emerald-400');
            }
        }
    </script>
</body>
</html>